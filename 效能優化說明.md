# 效能優化說明

## 🔧 已修正的問題

### 1. ✅ 關閉爬蟲功能（解決頁面卡住問題）

**問題**：
- 露天爬蟲使用同步請求，效率低且易被擋
- 爬蟲會阻塞 Flask 請求，導致頁面一直轉圈圈

**解決方案**：
- 在 `app.py` 中暫時關閉 `get_reference_prices()` 爬蟲功能
- 在 `data_engine.py` 中關閉 `_scrape_prices()` 後備爬蟲
- 直接回傳空結果，避免阻塞

**修改位置**：
- `app.py` 第 189-194 行：參考價格爬蟲已關閉
- `data_engine.py` 第 360-375 行：後備爬蟲已關閉

### 2. ✅ 統一資料格式（解決 Kaggle 資料集不相容問題）

**問題**：
- Kaggle 資料集 `iphoneFeaturesPriceDataset.csv` 使用不同欄位名稱
- `current_price(LKR)` 而非 `price`
- `Model` 而非 `model`
- 缺少 `condition`、`warranty_months` 等必要欄位
- 導致 `PriceAnalyzer` 無法正常運作

**解決方案**：
- 新增 `_normalize_dataframe()` 方法統一資料格式
- 自動轉換 Kaggle 資料集格式：
  - `current_price(LKR)` → `price`（匯率轉換：LKR * 0.1）
  - `Model` → `model` 和 `item_name`
  - 自動補齊缺失欄位（`condition`、`warranty_months` 等）
  - 根據損壞欄位推斷 `condition` 和 `screen_broken`

**修改位置**：
- `data_engine.py` 第 82-155 行：新增資料格式統一功能

## 📊 資料格式轉換對照表

| Kaggle 原始欄位 | 轉換後欄位 | 說明 |
|----------------|-----------|------|
| `current_price(LKR)` | `price` | LKR * 0.1 轉換為台幣 |
| `Model` | `model`, `item_name` | 型號名稱 |
| `backglass_damages` | `condition` | Yes→1分, No→4分 |
| `screen_damages` | `screen_broken` | Yes→1, No→0 |
| - | `warranty_months` | 預設 0 |
| - | `camera_ok` | 預設 1（完好）|
| - | `battery_health` | 預設 0.85（85%）|
| `Storage` | `storage` | 提取數字（如 "128GB" → 128）|

## ⚡ 效能改善

### 改善前：
- 頁面載入時間：**10-30 秒**（甚至超時）
- 原因：等待爬蟲回應

### 改善後：
- 頁面載入時間：**< 2 秒**
- 原因：直接從資料庫讀取，無需等待爬蟲

## 🔄 未來改進方向

### 1. 非同步爬蟲（建議）
使用 `asyncio` 或 `celery` 實作非同步爬蟲：
- 不阻塞主請求
- 背景執行爬蟲
- 結果可稍後顯示

### 2. 快取機制
- 快取爬蟲結果
- 避免重複請求
- 定期更新快取

### 3. API 整合
- 使用官方 API（如有提供）
- 更穩定可靠
- 避免反爬蟲問題

## 📝 使用說明

### 目前狀態：
- ✅ 資料庫查詢：正常運作
- ✅ CSV 檔案查詢：正常運作
- ✅ 模糊匹配：正常運作
- ❌ 爬蟲功能：已暫時關閉

### 如果需要啟用爬蟲：
1. 修改 `app.py` 第 190 行，取消註解：
   ```python
   reference_prices = data_engine.get_reference_prices('iPhone', max_items=5)
   ```

2. 修改 `data_engine.py` 第 360 行，取消註解爬蟲邏輯

3. 建議實作非同步機制，避免阻塞

---

**最後更新：** 2024年

