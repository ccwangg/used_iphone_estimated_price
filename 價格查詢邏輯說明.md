# 價格查詢邏輯流程說明

## 📋 概述

本系統採用**完全誠實**的資料處理方式，**絕不編造資料**。所有價格資料都來自真實來源。

---

## 🔄 查詢邏輯流程

### 步驟 1: 查詢資料庫（精確匹配）

首先在 `mock_data.csv` 資料庫中搜尋：
- 使用**精確匹配**（不區分大小寫）
- 如果找到完全相同的型號，立即回傳結果
- **不進行任何資料編造**

```python
# 範例：搜尋 "iPhone 15 Pro"
# 資料庫中有 "iPhone 15 Pro" -> 直接回傳
# 資料庫中沒有 -> 進入下一步
```

### 步驟 2: 查詢資料庫（部分匹配）

如果精確匹配失敗，嘗試部分匹配：
- 搜尋包含關鍵字的型號
- 例如：「iPhone 15」可以匹配「iPhone 15 Pro」、「iPhone 15 Plus」等

### 步驟 3: 查詢資料目錄中的 CSV 檔案

在 `gemma-keras-gemma_1.1_instruct_2b_en-v4` 資料夾中搜尋所有 CSV 檔案：

1. **精確匹配**：在每個 CSV 檔案中搜尋完全相同的型號
2. **部分匹配**：搜尋包含關鍵字的型號
3. **模糊匹配**：使用 TheFuzz 套件進行相似度匹配

#### 模糊匹配說明

使用 **TheFuzz** 套件進行智能匹配：

```python
# 範例匹配：
"iPhone 15 Pro" -> "iPhone15Pro" (相似度: 85%)
"iPhone 13" -> "iPhone13" (相似度: 90%)
"iPhone 14 Pro Max" -> "iPhone14ProMax" (相似度: 88%)
```

- **最低相似度要求**：70%（可調整）
- 如果相似度低於 70%，視為不匹配
- **絕不編造資料**，找不到就找不到

### 步驟 4: 觸發爬蟲（後備機制）

如果資料庫和 CSV 檔案都找不到，才啟動爬蟲：

1. **蝦皮購物爬蟲**
2. **露天拍賣爬蟲**

#### 自動儲存機制

當爬蟲成功取得資料時，**自動儲存**到 `mock_data.csv`：

```python
# 爬蟲取得資料後
scraped_data = [
    {
        'item_name': 'iPhone 15 Pro',
        'model': 'iPhone 15 Pro',
        'price': 25000,
        'platform': '露天',
        'title': 'iPhone 15 Pro 256GB',
        'url': 'https://...'
    },
    # ...
]

# 自動儲存到資料庫
data_engine._save_to_database(scraped_data)
```

**優點**：
- 下次查詢相同型號時，直接從資料庫讀取（更快）
- 累積真實的市場價格資料
- 減少爬蟲請求次數

---

## 📁 資料來源優先順序

1. **`mock_data.csv`**（資料庫）
   - 包含之前爬蟲取得的資料
   - 優先查詢，速度最快

2. **`gemma-keras-gemma_1.1_instruct_2b_en-v4/`**（Kaggle 資料集）
   - 包含真實的手機規格與價格資料
   - 使用模糊匹配找到相似型號

3. **爬蟲（後備）**
   - 只有在資料庫和資料集都找不到時才使用
   - 取得的資料會自動儲存到資料庫

---

## 🚫 不編造資料原則

系統**嚴格遵守**以下原則：

1. ✅ **只使用真實資料**
   - 從資料庫讀取
   - 從 Kaggle 資料集讀取
   - 從爬蟲取得

2. ❌ **絕不編造資料**
   - 不會產生模擬價格
   - 不會使用預設值代替
   - 找不到就回傳空結果

3. ✅ **誠實回報**
   - 如果找不到資料，顯示「找不到相關價格資料」
   - 不會用假資料誤導使用者

---

## 🔧 技術實作

### TheFuzz 模糊匹配

```python
from thefuzz import fuzz, process

# 找到最相似的型號
result = process.extractOne(
    "iPhone 15 Pro",
    ["iPhone15Pro", "iPhone 14 Pro", "iPhone 13"],
    scorer=fuzz.ratio
)

# result = ("iPhone15Pro", 85, 0)
# 85% 相似度，超過 70% 最低要求
```

### 自動儲存機制

```python
def _save_to_database(self, new_data):
    """將新資料儲存到資料庫"""
    # 合併到現有資料庫
    self.database_df = pd.concat([self.database_df, new_df])
    # 移除重複
    self.database_df = self.database_df.drop_duplicates()
    # 儲存到檔案
    self.database_df.to_csv(self.database_file, ...)
```

---

## 📊 查詢流程圖

```
開始查詢 "iPhone 15 Pro"
    │
    ├─→ 步驟 1: 查詢資料庫（精確匹配）
    │       ├─→ 找到？ → 回傳結果 ✓
    │       └─→ 沒找到 → 繼續
    │
    ├─→ 步驟 2: 查詢資料庫（部分匹配）
    │       ├─→ 找到？ → 回傳結果 ✓
    │       └─→ 沒找到 → 繼續
    │
    ├─→ 步驟 3: 查詢資料目錄 CSV
    │       ├─→ 精確匹配 → 找到？ → 回傳結果 ✓
    │       ├─→ 部分匹配 → 找到？ → 回傳結果 ✓
    │       └─→ 模糊匹配 → 相似度 ≥ 70%？ → 回傳結果 ✓
    │
    └─→ 步驟 4: 觸發爬蟲
            ├─→ 取得資料？ → 儲存到資料庫 → 回傳結果 ✓
            └─→ 無法取得？ → 回傳空結果 ❌
```

---

## ⚙️ 設定參數

在 `app.py` 中初始化資料引擎：

```python
data_engine = DataEngine(
    data_dir='gemma-keras-gemma_1.1_instruct_2b_en-v4',  # 資料目錄
    database_file='mock_data.csv',                         # 資料庫檔案
    min_similarity=70                                       # 最低相似度（%）
)
```

### 可調整參數

- **`min_similarity`**: 模糊匹配最低相似度（預設 70%）
  - 提高：更嚴格，減少誤匹配
  - 降低：更寬鬆，可能增加誤匹配

---

## 📝 使用範例

### 範例 1: 資料庫中有資料

```python
# 查詢 "iPhone 15 Pro"
# 資料庫中有 "iPhone 15 Pro" 的資料
# → 直接從資料庫回傳（最快）
```

### 範例 2: 模糊匹配成功

```python
# 查詢 "iPhone 15 Pro"
# 資料庫中沒有，但 CSV 中有 "iPhone15Pro"
# → TheFuzz 匹配成功（相似度 85%）
# → 回傳 CSV 中的資料
```

### 範例 3: 觸發爬蟲

```python
# 查詢 "iPhone 16 Pro"（新機型）
# 資料庫和 CSV 都沒有
# → 觸發爬蟲
# → 爬蟲取得 5 筆資料
# → 自動儲存到 mock_data.csv
# → 回傳爬蟲資料
```

### 範例 4: 完全找不到

```python
# 查詢 "未知型號"
# 資料庫、CSV、爬蟲都找不到
# → 回傳空 DataFrame
# → 顯示「找不到相關價格資料」
```

---

## ✅ 優點

1. **完全誠實**：絕不編造資料
2. **智能匹配**：使用模糊匹配找到相似型號
3. **自動學習**：爬蟲資料自動儲存，累積資料庫
4. **高效查詢**：優先使用資料庫，速度快
5. **後備機制**：資料庫找不到時才使用爬蟲

---

**最後更新：** 2024年

