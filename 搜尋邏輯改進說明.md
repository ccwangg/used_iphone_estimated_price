# 搜尋邏輯改進說明

## 🔧 問題診斷

### 問題 1: YOLO 辨識太籠統
- **現況**：YOLO 模型只辨識出大類別 "cell phone"，系統轉譯為 "iPhone"
- **後果**：拿著 "iPhone" 這個太廣泛的詞去搜尋，無法匹配到 "iPhone 13" 等具體型號

### 問題 2: 資料庫搜尋太嚴格
- **現況**：精確匹配要求字串完全一樣
- **後果**：搜尋 "iPhone" 無法匹配到 "iPhone 13"、"iPhone 14 Pro" 等

### 問題 3: 模糊匹配門檻太高
- **現況**：相似度門檻設為 70%，"iPhone" 對 "iPhone 13" 的相似度可能不夠
- **後果**：即使有相關資料，也被判定為不匹配

---

## ✅ 解決方案

### 改進 1: 寬鬆的部分匹配（優先使用）

修改 `_search_database()` 方法，使用 `str.contains()` 進行寬鬆搜尋：

```python
# 部分匹配（寬鬆搜尋）
matched = self.database_df[
    self.database_df[model_col].str.lower().str.contains(item_name.lower(), na=False)
]
```

**效果**：
- 搜尋 "iPhone" → 可以匹配到：
  - "iPhone 13"
  - "iPhone 14 Pro"
  - "iPhone 15 Pro Max"
  - 所有包含 "iPhone" 的型號

### 改進 2: 降低通用詞的模糊匹配門檻

在 `get_prices()` 方法中，針對通用詞降低門檻：

```python
# 如果搜尋詞是通用詞（如 "iPhone"），降低相似度要求
current_threshold = self.min_similarity
if item_name.lower() in ['iphone', 'phone', 'cell phone', 'mobile']:
    # 對於通用詞，降低門檻到 50%
    current_threshold = 50
    print(f"偵測到通用詞 '{item_name}'，降低模糊匹配門檻至 {current_threshold}%")
```

**效果**：
- "iPhone" 對 "iPhone 13" 的相似度約 67%
- 原本門檻 70% 會失敗
- 降低到 50% 後可以成功匹配

### 改進 3: 優化搜尋順序

調整搜尋順序，讓寬鬆搜尋優先於模糊匹配：

1. **精確匹配**（最快，最準確）
2. **部分匹配**（寬鬆，可以處理通用詞）
3. **模糊匹配**（降低門檻，處理變體）

---

## 📊 搜尋流程（改進後）

```
開始查詢 "iPhone"
    │
    ├─→ 步驟 1: 資料庫精確匹配 "iPhone"
    │       └─→ 沒找到（資料庫中是 "iPhone 13"）
    │
    ├─→ 步驟 2: 資料庫部分匹配（寬鬆搜尋）
    │       ├─→ 搜尋包含 "iPhone" 的所有型號
    │       └─→ ✓ 找到 "iPhone 13"、"iPhone 14" 等
    │       └─→ 回傳結果 ✓
    │
    └─→ （如果步驟 2 失敗）
            ├─→ 步驟 3: CSV 檔案部分匹配
            ├─→ 步驟 4: 模糊匹配（降低門檻）
            └─→ 步驟 5: 觸發爬蟲
```

---

## 🎯 實際效果

### 範例 1: 搜尋 "iPhone"

**改進前**：
```
搜尋 "iPhone"
→ 精確匹配失敗（資料庫中是 "iPhone 13"）
→ 部分匹配失敗（邏輯有問題）
→ 模糊匹配失敗（相似度 67% < 70%）
→ 觸發爬蟲（可能失敗）
→ ❌ 找不到資料
```

**改進後**：
```
搜尋 "iPhone"
→ 精確匹配失敗（資料庫中是 "iPhone 13"）
→ 部分匹配成功（"iPhone" 包含在 "iPhone 13" 中）
→ ✓ 找到所有 iPhone 型號的資料
→ 回傳結果
```

### 範例 2: 搜尋 "iPhone 13"

**改進前/後**：
```
搜尋 "iPhone 13"
→ 精確匹配成功（如果資料庫中有 "iPhone 13"）
→ ✓ 立即回傳結果
```

### 範例 3: 搜尋 "iPhone15Pro"（無空格）

**改進前**：
```
搜尋 "iPhone15Pro"
→ 精確匹配失敗（資料庫中是 "iPhone 15 Pro"）
→ 部分匹配失敗（不包含空格）
→ 模糊匹配可能成功（相似度高）
```

**改進後**：
```
搜尋 "iPhone15Pro"
→ 精確匹配失敗
→ 部分匹配可能成功（如果資料庫中有包含 "iPhone" 的）
→ 模糊匹配成功（相似度 85% > 50%）
→ ✓ 找到資料
```

---

## 🔍 技術細節

### 部分匹配（str.contains）

```python
# 使用 pandas 的 str.contains 方法
matched = df[df['model'].str.lower().str.contains('iphone', na=False)]

# 這會匹配所有包含 "iphone" 的型號：
# - "iPhone 13"
# - "iPhone 14 Pro"
# - "iPhone 15 Pro Max"
# - "iPhone XS"
```

### 模糊匹配（降低門檻）

```python
# 對於通用詞，降低門檻
if item_name.lower() in ['iphone', 'phone', 'cell phone', 'mobile']:
    threshold = 50  # 降低到 50%
else:
    threshold = 70  # 保持原本的 70%

# 使用降低後的門檻進行匹配
matched = self._fuzzy_match(item_name, df, model_col, threshold=threshold)
```

---

## 📝 程式碼變更摘要

### 1. `_search_database()` 方法
- ✅ 保持精確匹配邏輯
- ✅ 改進部分匹配，使用 `str.contains()` 進行寬鬆搜尋

### 2. `_fuzzy_match()` 方法
- ✅ 新增 `threshold` 參數，允許動態調整門檻
- ✅ 保持原本的模糊匹配邏輯

### 3. `get_prices()` 方法
- ✅ 優化搜尋順序
- ✅ 針對通用詞降低模糊匹配門檻
- ✅ 加強日誌輸出，方便除錯

---

## 🚀 使用建議

### 短期解決方案（已實作）
- ✅ 使用寬鬆的部分匹配
- ✅ 降低通用詞的模糊匹配門檻
- ✅ 即使只辨識出 "iPhone"，也能找到所有 iPhone 型號的資料

### 長期改進方向
1. **訓練專門的 iPhone 型號辨識模型**
   - 使用 `iphone.v1` 資料集訓練 YOLO 模型
   - 讓模型能直接辨識出 "iPhone 13"、"iPhone 14 Pro" 等具體型號

2. **改進爬蟲功能**
   - 使用 Selenium 處理動態網頁
   - 實作更穩定的爬蟲邏輯

3. **資料庫優化**
   - 建立索引加速搜尋
   - 定期更新市場價格

---

## ✅ 測試建議

測試以下搜尋詞，確認都能找到資料：

1. ✅ "iPhone" → 應該找到所有 iPhone 型號
2. ✅ "iPhone 13" → 應該找到 iPhone 13 的資料
3. ✅ "iPhone15Pro" → 應該匹配到 "iPhone 15 Pro"
4. ✅ "phone" → 應該找到所有手機資料

---

**最後更新：** 2024年

